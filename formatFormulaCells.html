<!DOCTYPE html>
<html>
<head>
  <title>Custom Formatting</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Icons">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      width: 290px;
      background: transparent;
    }

    .format-container {
      border-radius: 4px;
      border: 1px solid #DADCE0;
      overflow: hidden; /* Ensures the "Custom" and toolbar stay connected */
    }

    .format-header {
      font-size: 14px;
      font-weight: lighter;
      color: #5F6368;
      padding: 6px;
      background-color: #E8F0FE;
      transition: background-color 0.3s ease, color 0.3s ease; /* ✅ Smooth transition */
    }

    .toolbar {
      display: flex;
      align-items: center;
      background-color: white;
      padding: 6px;
    }

    .toolbar button {
      border: none;
      background: none;
      font-size: 16px;
      padding: 4px 8px;
      cursor: pointer;
      color: #3C4043;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      transition: background 0.2s ease-in-out;
      position: relative;
    }

    .toolbar button:hover {
      background-color: rgba(200, 200, 200, 0.2);
    }

    .toolbar button.active {
      background-color: #D2E3FC;
    }

.tooltip {
  position: absolute;
  bottom: 100%; /* ✅ Moves tooltip above the button */
  left: 50%;
  transform: translateX(-50%);
  background-color: #3C4043;
  color: white;
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 3px;
  white-space: nowrap;
  display: none;
  z-index: 1000; /* ✅ Ensures tooltips are on top */
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
}

.toolbar button:hover .tooltip,
.color-picker-container:hover .tooltip { /* ✅ Added hover for color pickers */
  display: block;
}

    .separator {
      width: 1px;
      height: 24px;
      background-color: #B0BEC5;
      margin: 0 8px;
    }

    .color-container {
      display: flex;
      align-items: center;
    }

    .color-picker-container {
      position: relative;
      display: flex;
      align-items: center;
      cursor: pointer;
      border: 1px solid #DADCE0;
      border-radius: 3px;
      background-color: white;
      margin-left: 5px;
      width: 34px;
      height: 28px;
      justify-content: center;
      padding: 4px;
      transition: background 0.2s ease-in-out;
    }

    .color-picker-container:hover {
      background-color: rgba(200, 200, 200, 0.2);
    }

    .color-icon {
      font-size: 18px;
      color: #3C4043;
      cursor: pointer;
    }

    .hidden-picker {
      position: absolute;
      opacity: 0;
      width: 34px;
      height: 28px;
      cursor: pointer;
    }

    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .apply-btn, .cancel-btn {
      flex: 1;
      border: none;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      color: white;
      border-radius: 5px;
      text-align: center;
    }

  /* ✅ Disable buttons WITHOUT changing opacity */
    .disabled {
      pointer-events: none;  /* ✅ Prevents clicks */
      filter: grayscale(70%); /* ✅ Makes it look slightly inactive */
    }

 /* ✅ Hide tooltips when button is disabled */
.disabled .tooltip {
  display: none !important;
}

    .apply-btn {
      background-color: #188038;
      margin-right: 5px;
    }

    .cancel-btn {
      background-color: #D93025;
    }

    .cancel-btn:disabled {
  background-color: #d6d6d6 !important; /* ✅ Gray out the button */
  color: #a1a1a1 !important; /* ✅ Dim text */
  cursor: not-allowed !important; /* ✅ Show "not allowed" cursor */
  opacity: 0.6;
}

    #status {
      margin-top: 10px;
      font-size: 14px;
    }

/* ✅ Center the spinner */
.spinner-container {
  display: flex;  
  justify-content: center; /* ✅ Centers horizontally */
  align-items: center; /* ✅ Centers vertically */
  height: 50px; /* ✅ Ensures proper spacing */
}

    #spinner {
      display: none;
    }
  </style>
</head>
<body>
  <div class="format-container">
    <div class="format-header">Custom</div>
    <div class="toolbar">
<button id="boldBtn" onclick="toggleStyle('bold')">
  <span class="material-icons">format_bold</span>
  <span class="tooltip">Bold</span>
</button>

<button id="italicBtn" onclick="toggleStyle('italic')">
  <span class="material-icons">format_italic</span>
  <span class="tooltip">Italic</span>
</button>

<button id="underlineBtn" onclick="toggleStyle('underline')">
  <span class="material-icons">format_underlined</span>
  <span class="tooltip">Underline</span>
</button>

<button id="strikethroughBtn" onclick="toggleStyle('strikethrough')">
  <span class="material-icons">format_strikethrough</span>
  <span class="tooltip">Strikethrough</span>
</button>

      <div class="separator"></div>

<div class="color-container">
  <!-- Font Color Picker -->
<div class="color-picker-container">
  <span class="material-icons" id="textColorIcon">format_color_text</span>
  <div class="tooltip">Font Color</div> <!-- ✅ Tooltip stays -->
  <input type="color" id="textColorPicker" class="hidden-picker" onchange="setColor('textColor', this.value); markColorChanged('textColor');">
</div>

  <!-- Background Color Picker -->
<div class="color-picker-container">
    <span class="material-icons" id="bgColorIcon">format_color_fill</span> <!-- ✅ Unique ID added -->
    <div class="tooltip">Background Color</div>
    <input type="color" id="bgColorPicker" class="hidden-picker" onchange="setColor('bgColor', this.value); markColorChanged('bgColor');">
  </div>



</div>
      </div>
    </div>
  </div>

  <div class="action-buttons">
    <button class="apply-btn" onclick="applyStyles()">Apply</button>
    <button class="cancel-btn" id="cancelBtn" onclick="cancelOperation()" disabled>Cancel</button>
  </div>

  <div class="spinner-container">
    <img id="spinner" src="https://www.google.com/images/spin-32.gif" alt="Processing...">
  </div>

  <div id="status"></div>

  <script>
  let colorChanged = {
    textColor: false,
    bgColor: false
  };

function toggleStyle(style) {
  const button = document.getElementById(style + "Btn");
  const header = document.querySelector(".format-header"); // ✅ Selects "Custom" div
  button.classList.toggle("active"); // ✅ First, toggle the active class
  if (!header) return; // ✅ Prevents errors if the element is missing
  // ✅ Apply styles based on the button's active state
  if (style === "bold") {
    header.style.fontWeight = button.classList.contains("active") ? "bold" : "normal";
  } else if (style === "italic") {
    header.style.fontStyle = button.classList.contains("active") ? "italic" : "normal";
  } else if (style === "underline") {
    header.style.textDecoration = button.classList.contains("active") ? "underline" : "none";
  } else if (style === "strikethrough") {
    header.style.textDecoration = button.classList.contains("active") ? "line-through" : "none";
  }
}


function setColor(type, value) {
  const header = document.querySelector(".format-header"); // ✅ Selects the "Custom" div
  if (type === "textColor") {
    header.style.color = value; // ✅ Correctly updates text color
    document.getElementById("textColorIcon").style.color = value; // ✅ Updates "A" icon dynamically
  } else if (type === "bgColor") {
    header.style.backgroundColor = value; // ✅ Correctly updates background color
    document.getElementById("bgColorIcon").style.color = value; // ✅ Updates Background Color button dynamically
  }
}

function applyStyles() {
  document.getElementById("spinner").style.display = "block";
  document.getElementById("status").innerText = "";
  const textColorPicker = document.getElementById("textColorPicker");
  const bgColorPicker = document.getElementById("bgColorPicker");

  // ✅ Disable formatting buttons while running
  disableFormattingButtons(true);

  // ✅ Enable "Cancel" button (make it active)
  const cancelBtn = document.getElementById("cancelBtn");
  cancelBtn.disabled = false;
  cancelBtn.classList.remove("cancel-btn:disabled"); // Remove disabled style

  let styles = {
    bold: document.getElementById("boldBtn").classList.contains("active"),
    italic: document.getElementById("italicBtn").classList.contains("active"),
    underline: document.getElementById("underlineBtn").classList.contains("active"),
    strikethrough: document.getElementById("strikethroughBtn").classList.contains("active"),
    textColor: colorChanged.textColor ? textColorPicker.value : "", // ✅ Apply only if changed
    bgColor: colorChanged.bgColor ? bgColorPicker.value : "" // ✅ Apply only if changed

  };

  google.script.run
    .withSuccessHandler(response => {
      document.getElementById("spinner").style.display = "none";
      document.getElementById("status").innerText = response;
      
      // ✅ Reset color change tracking after applying
      colorChanged.textColor = false;
      colorChanged.bgColor = false;

      // ✅ Re-enable formatting buttons when done
      disableFormattingButtons(false);

      // ✅ Disable "Cancel" button again
      cancelBtn.disabled = true;
      cancelBtn.classList.add("cancel-btn:disabled"); // Apply disabled style

      setTimeout(() => {
        document.getElementById("status").innerText = "";
      }, 3000);
    })
    .applyFormatting(styles); // ✅ Now passing styles correctly
}

// ✅ Function to disable/enable buttons
function disableFormattingButtons(disable) {
  document.querySelectorAll(".toolbar button, .apply-btn, .color-picker-container").forEach(element => {    
    element.disabled = disable; // ✅ Disables buttons properly
    element.style.pointerEvents = disable ? "none" : "auto"; // ✅ Prevents user interactions
    // ✅ Add or remove `.disabled` class to ensure tooltips also disappear
    if (disable) {
      element.classList.add("disabled");
    } else {
      element.classList.remove("disabled");
    }
  });
}



function markColorChanged(type) {
  colorChanged[type] = true; // ✅ Updates only when the user selects a color
}

function cancelOperation() {
  google.script.run
    .withSuccessHandler(response => {
      document.getElementById("status").innerText = response;

      // ✅ Disable "Cancel" button since cancellation is complete
      const cancelBtn = document.getElementById("cancelBtn");
      cancelBtn.disabled = true;
      cancelBtn.classList.add("cancel-btn:disabled"); // Apply disabled style

      // ✅ Re-enable buttons & color pickers when cancelled
      disableFormattingButtons(false);

      setTimeout(() => {
        document.getElementById("status").innerText = "";
      }, 3000);
    })
    .cancelFormatting();
}

  </script>
</body>
</html>
