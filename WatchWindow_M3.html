<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
      :root {
        --bg: #ffffff;
        --text: #202124;
        --muted: #5f6368;
        --muted-light: #80868b;
        --divider: #e0e0e0;
        --hover: #f1f3f4;
        --primary: #1a73e8;
        --danger: #d93025;
        --banner-info-bg: #f1f3f4;
        --banner-error-bg: #fce8e6;
      }

      body {
        margin: 0;
        padding: 12px 12px 16px 12px;
        font-family: Roboto, Arial, sans-serif;
        font-size: 13px;
        color: var(--text);
        background: var(--bg);
      }

      .header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        padding: 4px 0 10px 0;
        border-bottom: 1px solid var(--divider);
      }

      .title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
      }

      .subtitle {
        font-size: 11px;
        color: var(--muted-light);
      }

      .toolbar {
        display: flex;
        gap: 8px;
        padding: 12px 0 10px 0;
        align-items: center;
      }

      .btn {
        height: 32px;
        border-radius: 4px;
        padding: 0 12px;
        font-size: 13px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        user-select: none;
        border: 1px solid var(--divider);
        background: #fff;
        color: var(--text);
      }

      .btn:hover { background: var(--hover); }
      .btn:disabled { opacity: 0.55; cursor: default; }

      .btn.primary {
        background: var(--primary);
        border: 1px solid var(--primary);
        color: #fff;
      }
      .btn.primary:hover { background: #1765cc; }

      .btn .material-icons {
        font-size: 18px;
        line-height: 18px;
      }

      .banner {
        display: none;
        margin: 0 0 8px 0;
        padding: 8px 12px;
        border-radius: 4px;
        background: var(--banner-info-bg);
        color: var(--text);
        font-size: 12px;
        line-height: 16px;
      }

      .banner.error {
        background: var(--banner-error-bg);
        color: var(--danger);
      }

      .list {
        border-top: 1px solid var(--divider);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr auto 32px;
        gap: 8px;
        align-items: center;
        min-height: 44px;
        padding: 8px;
        border-bottom: 1px solid var(--divider);
      }

      .row:hover { background: var(--hover); }

      .loc {
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .label {
        font-size: 13px;
        color: var(--text);
        line-height: 18px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
      }

      .label:hover {
        color: var(--primary);
      }

      .meta {
        font-size: 11px;
        color: var(--muted-light);
        line-height: 14px;
      }

      .value {
        font-weight: 500;
        text-align: right;
        white-space: nowrap;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 13px;
      }

      .value.error { color: var(--danger); }

      .iconbtn {
        width: 28px;
        height: 28px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--muted-light);
        opacity: 0;
        transition: opacity 0.15s ease;
      }

      .row:hover .iconbtn { opacity: 1; }
      .iconbtn:focus { opacity: 1; outline: none; }
      
      .iconbtn:hover { 
        background: #fce8e6; 
        color: var(--danger); 
      }

      .iconbtn .material-icons { font-size: 18px; }

      .empty {
        padding: 32px 16px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .empty .material-icons {
        font-size: 24px;
        color: var(--muted-light);
      }

      .empty-text {
        font-size: 13px;
        color: var(--muted);
        line-height: 18px;
      }

      .empty-hint {
        font-size: 12px;
        color: var(--muted-light);
        line-height: 16px;
      }

      .footer-actions {
        display: none;
        padding: 12px 8px 0 8px;
        border-top: 1px solid var(--divider);
        margin-top: 8px;
      }

      .footer-actions.visible {
        display: block;
      }

      .linkbtn {
        border: none;
        background: transparent;
        color: var(--primary);
        cursor: pointer;
        font-size: 13px;
        padding: 8px 0;
        font-weight: 500;
      }
      .linkbtn:hover { text-decoration: underline; }
      .linkbtn:disabled { opacity: 0.55; cursor: default; }
    </style>
  </head>

  <body>
    <div class="header">
      <div class="title">Watch window</div>
      <div class="subtitle" id="lastRefreshed">Last refreshed: -</div>
    </div>

    <div id="banner" class="banner"></div>

    <div class="toolbar">
      <button class="btn primary" id="btnAdd" onclick="addWatch()">
        <span class="material-icons">add</span>
        Add watch
      </button>

      <button class="btn" id="btnRefresh" onclick="refreshList()">
        <span class="material-icons">refresh</span>
        Refresh
      </button>
    </div>

    <div id="list" class="list"></div>

    <div class="footer-actions" id="footer">
      <button class="linkbtn" id="btnRemoveMissing" onclick="removeMissing()">
        Remove broken watches
      </button>
    </div>

    <script>
      let bannerTimer = null;

      function toErrorMessage(err) {
        try {
          if (err && typeof err === 'object') return err.message || JSON.stringify(err, null, 2);
          return String(err);
        } catch (e) {
          return 'Unknown error (failed to stringify)';
        }
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function setBusy(isBusy) {
        document.getElementById('btnAdd').disabled = isBusy;
        document.getElementById('btnRefresh').disabled = isBusy;
      }

      function showBanner(message, isError) {
        clearBanner();
        const b = document.getElementById('banner');
        b.innerText = message;
        if (isError) {
          b.classList.add('error');
        }
        b.style.display = 'block';
        
        // Auto-hide after 5 seconds
        bannerTimer = setTimeout(() => {
          clearBanner();
        }, 5000);
      }

      function clearBanner() {
        if (bannerTimer) {
          clearTimeout(bannerTimer);
          bannerTimer = null;
        }
        const b = document.getElementById('banner');
        b.style.display = 'none';
        b.innerText = '';
        b.classList.remove('error');
      }

      function formatTime(ts) {
        try {
          const d = new Date(ts);
          const hh = String(d.getHours()).padStart(2, '0');
          const mm = String(d.getMinutes()).padStart(2, '0');
          const ss = String(d.getSeconds()).padStart(2, '0');
          return hh + ':' + mm + ':' + ss;
        } catch (e) {
          return '-';
        }
      }

      function updateLastRefreshed(serverNow) {
        document.getElementById('lastRefreshed').innerText = 'Last refreshed: ' + formatTime(serverNow);
      }

      function updateFooterVisibility(hasMissing) {
        const footer = document.getElementById('footer');
        if (hasMissing) {
          footer.classList.add('visible');
        } else {
          footer.classList.remove('visible');
        }
      }

      function render(payload) {
        const list = document.getElementById('list');

        const items = payload && payload.items ? payload.items : [];
        const serverNow = payload && payload.serverNow ? payload.serverNow : null;

        if (serverNow) updateLastRefreshed(serverNow);

        if (!items || items.length === 0) {
          updateFooterVisibility(false);
          list.innerHTML = `
            <div class="empty">
              <span class="material-icons">visibility</span>
              <div class="empty-text">No watches yet</div>
              <div class="empty-hint">Select a cell and click Add watch</div>
            </div>
          `;
          return;
        }

        const hasMissing = items.some(x => x.status === 'SHEET_MISSING');
        updateFooterVisibility(hasMissing);

        let html = '';
        items.forEach(item => {
          if (item.status === 'SHEET_MISSING') {
            html += `
              <div class="row" id="row-${escapeHtml(item.id)}">
                <div class="loc">
                  <div class="label">Missing sheet (id: ${escapeHtml(item.sheetId)})</div>
                  <div class="meta">Sheet deleted or unavailable</div>
                </div>
                <div class="value error">Error</div>
                <div class="iconbtn" tabindex="0" title="Remove" onclick="removeItem('${escapeHtml(item.id)}')">
                  <span class="material-icons">close</span>
                </div>
              </div>
            `;
          } else {
            const valueClass = item.isErrorValue ? 'value error' : 'value';
            const labelText = escapeHtml(item.sheetName) + '!' + escapeHtml(item.cellRef);
            html += `
              <div class="row" id="row-${escapeHtml(item.id)}">
                <div class="loc">
                  <div class="label" title="Go to cell" onclick="jumpTo(${item.sheetId}, ${item.row}, ${item.col})">${labelText}</div>
                </div>
                <div class="${valueClass}">${escapeHtml(item.value)}</div>
                <div class="iconbtn" tabindex="0" title="Remove" onclick="removeItem('${escapeHtml(item.id)}')">
                  <span class="material-icons">close</span>
                </div>
              </div>
            `;
          }
        });

        list.innerHTML = html;
      }

      function addWatch() {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(res => {
            if (res && res.added === false && res.reason === 'DUPLICATE') {
              showBanner('Already watching that cell.', false);
              setBusy(false);
              return;
            }
            refreshList();
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err), true);
          })
          .addActiveCellToWatchM3();
      }

      function refreshList() {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(payload => {
            setBusy(false);
            render(payload);
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err), true);
          })
          .getWatchListM3();
      }

      function removeItem(id) {
        clearBanner();

        const row = document.getElementById('row-' + id);
        if (row) row.style.opacity = '0.4';

        setBusy(true);
        google.script.run
          .withSuccessHandler(() => refreshList())
          .withFailureHandler(err => {
            setBusy(false);
            if (row) row.style.opacity = '1';
            showBanner('Error: ' + toErrorMessage(err), true);
          })
          .removeWatchItemM3(id);
      }

      function removeMissing() {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(res => {
            refreshList();
            if (res && typeof res.removedCount === 'number' && res.removedCount > 0) {
              showBanner('Removed ' + res.removedCount + ' broken watch(es).', false);
            }
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err), true);
          })
          .removeMissingWatchesM3();
      }

      function jumpTo(sheetId, row, col) {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(res => {
            setBusy(false);
            if (!res || res.ok !== true) {
              showBanner('Could not navigate: ' + (res && res.reason ? res.reason : 'UNKNOWN'), true);
            }
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err), true);
          })
          .jumpToWatchCellM3(sheetId, row, col);
      }

      // Initial load
      refreshList();
    </script>
  </body>
</html>
