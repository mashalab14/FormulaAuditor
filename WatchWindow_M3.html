<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
      :root {
        --bg: #ffffff;
        --text: #202124;
        --muted: #5f6368;
        --divider: #e0e0e0;
        --hover: #f1f3f4;
        --primary: #1a73e8;
        --danger: #d93025;
      }

      body {
        margin: 0;
        padding: 12px 12px 16px 12px;
        font-family: Roboto, Arial, sans-serif;
        font-size: 13px;
        color: var(--text);
        background: var(--bg);
      }

      .header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        padding: 4px 0 10px 0;
        border-bottom: 1px solid var(--divider);
      }

      .title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
      }

      .subtitle {
        font-size: 12px;
        color: var(--muted);
      }

      .toolbar {
        display: flex;
        gap: 8px;
        padding: 12px 0 10px 0;
        align-items: center;
      }

      .btn {
        height: 32px;
        border-radius: 8px;
        padding: 0 10px;
        font-size: 13px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        user-select: none;
        border: 1px solid var(--divider);
        background: #fff;
        color: var(--text);
      }

      .btn:hover { background: var(--hover); }
      .btn:disabled { opacity: 0.55; cursor: default; }

      .btn.primary {
        background: var(--primary);
        border: 1px solid var(--primary);
        color: #fff;
      }
      .btn.primary:hover { filter: brightness(0.95); }

      .btn .material-icons {
        font-size: 18px;
        line-height: 18px;
      }

      .banner {
        display: none;
        margin: 0 0 10px 0;
        padding: 8px 10px;
        border-radius: 8px;
        background: #fce8e6;
        color: var(--danger);
        font-size: 12px;
        white-space: pre-wrap;
      }

      .list {
        border-top: 1px solid var(--divider);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr auto 28px;
        gap: 8px;
        align-items: center;
        padding: 10px 6px;
        border-bottom: 1px solid var(--divider);
      }

      .row:hover { background: var(--hover); }

      .loc {
        min-width: 0;
      }

      .sheet {
        font-size: 11px;
        color: var(--muted);
        line-height: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .cell {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-weight: 700;
        color: var(--primary);
        line-height: 18px;
        cursor: pointer;
      }

      .value {
        font-weight: 500;
        text-align: right;
        white-space: nowrap;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .value.error { color: var(--danger); }

      .iconbtn {
        width: 28px;
        height: 28px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--muted);
      }
      .iconbtn:hover { background: #e8eaed; color: var(--danger); }

      .iconbtn .material-icons { font-size: 18px; }

      .empty {
        padding: 18px 6px;
        color: var(--muted);
        font-size: 12px;
        line-height: 18px;
      }

      .missing {
        color: var(--danger);
        font-size: 12px;
        line-height: 18px;
      }

      .footer-actions {
        display: flex;
        justify-content: flex-end;
        padding: 10px 0 0 0;
      }

      .linkbtn {
        border: none;
        background: transparent;
        color: var(--primary);
        cursor: pointer;
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 6px;
      }
      .linkbtn:hover { background: var(--hover); }
      .linkbtn:disabled { opacity: 0.55; cursor: default; }
    </style>
  </head>

  <body>
    <div class="header">
      <div class="title">Watch window</div>
      <div class="subtitle" id="lastRefreshed">Last refreshed: -</div>
    </div>

    <div id="banner" class="banner"></div>

    <div class="toolbar">
      <button class="btn primary" id="btnAdd" onclick="addWatch()">
        <span class="material-icons">add</span>
        Add watch
      </button>

      <button class="btn" id="btnRefresh" onclick="refreshList()">
        <span class="material-icons">refresh</span>
        Refresh
      </button>
    </div>

    <div id="list" class="list"></div>

    <div class="footer-actions">
      <button class="linkbtn" id="btnRemoveMissing" onclick="removeMissing()" disabled>
        Remove missing
      </button>
    </div>

    <script>
      function toErrorMessage(err) {
        try {
          if (err && typeof err === 'object') return err.message || JSON.stringify(err, null, 2);
          return String(err);
        } catch (e) {
          return 'Unknown error (failed to stringify)';
        }
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function setBusy(isBusy) {
        document.getElementById('btnAdd').disabled = isBusy;
        document.getElementById('btnRefresh').disabled = isBusy;
        document.getElementById('btnRemoveMissing').disabled = isBusy || !window.__hasMissing;
      }

      function showBanner(message) {
        const b = document.getElementById('banner');
        b.style.display = 'block';
        b.innerText = message;
      }

      function clearBanner() {
        const b = document.getElementById('banner');
        b.style.display = 'none';
        b.innerText = '';
      }

      function formatTime(ts) {
        try {
          const d = new Date(ts);
          const hh = String(d.getHours()).padStart(2, '0');
          const mm = String(d.getMinutes()).padStart(2, '0');
          const ss = String(d.getSeconds()).padStart(2, '0');
          return hh + ':' + mm + ':' + ss;
        } catch (e) {
          return '-';
        }
      }

      function updateLastRefreshed(serverNow) {
        document.getElementById('lastRefreshed').innerText = 'Last refreshed: ' + formatTime(serverNow);
      }

      function render(payload) {
        const list = document.getElementById('list');

        const items = payload && payload.items ? payload.items : [];
        const serverNow = payload && payload.serverNow ? payload.serverNow : null;

        if (serverNow) updateLastRefreshed(serverNow);

        if (!items || items.length === 0) {
          window.__hasMissing = false;
          document.getElementById('btnRemoveMissing').disabled = true;
          list.innerHTML = '<div class="empty">No watches yet. Select a cell in the sheet, then click "Add watch".</div>';
          return;
        }

        const hasMissing = items.some(x => x.status === 'SHEET_MISSING');
        window.__hasMissing = hasMissing;
        document.getElementById('btnRemoveMissing').disabled = !hasMissing;

        let html = '';
        items.forEach(item => {
          if (item.status === 'SHEET_MISSING') {
            html += `
              <div class="row" id="row-${escapeHtml(item.id)}">
                <div class="loc">
                  <div class="sheet">Missing sheet</div>
                  <div class="missing">Sheet deleted or unavailable (id: ${escapeHtml(item.sheetId)})</div>
                </div>
                <div class="value error">Error</div>
                <div class="iconbtn" title="Remove" onclick="removeItem('${escapeHtml(item.id)}')">
                  <span class="material-icons">close</span>
                </div>
              </div>
            `;
          } else {
            const valueClass = item.isErrorValue ? 'value error' : 'value';
            html += `
              <div class="row" id="row-${escapeHtml(item.id)}">
                <div class="loc">
                  <div class="sheet">${escapeHtml(item.sheetName)}</div>
                  <div class="cell" title="Go to cell" onclick="jumpTo(${item.sheetId}, ${item.row}, ${item.col})">${escapeHtml(item.cellRef)}</div>
                </div>
                <div class="${valueClass}">${escapeHtml(item.value)}</div>
                <div class="iconbtn" title="Remove" onclick="removeItem('${escapeHtml(item.id)}')">
                  <span class="material-icons">close</span>
                </div>
              </div>
            `;
          }
        });

        list.innerHTML = html;
      }

      function addWatch() {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(res => {
            if (res && res.added === false && res.reason === 'DUPLICATE') {
              showBanner('Already watching that cell.');
              setBusy(false);
              return;
            }
            refreshList();
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err));
          })
          .addActiveCellToWatchM3();
      }

      function refreshList() {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(payload => {
            setBusy(false);
            render(payload);
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err));
          })
          .getWatchListM3();
      }

      function removeItem(id) {
        clearBanner();

        const row = document.getElementById('row-' + id);
        if (row) row.style.opacity = '0.4';

        setBusy(true);
        google.script.run
          .withSuccessHandler(() => refreshList())
          .withFailureHandler(err => {
            setBusy(false);
            if (row) row.style.opacity = '1';
            showBanner('Error: ' + toErrorMessage(err));
          })
          .removeWatchItemM3(id);
      }

      function removeMissing() {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(res => {
            refreshList();
            if (res && typeof res.removedCount === 'number' && res.removedCount > 0) {
              showBanner('Removed ' + res.removedCount + ' missing item(s).');
            }
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err));
          })
          .removeMissingWatchesM3();
      }

      function jumpTo(sheetId, row, col) {
        clearBanner();
        setBusy(true);

        google.script.run
          .withSuccessHandler(res => {
            setBusy(false);
            if (!res || res.ok !== true) {
              showBanner('Could not navigate: ' + (res && res.reason ? res.reason : 'UNKNOWN'));
            }
          })
          .withFailureHandler(err => {
            setBusy(false);
            showBanner('Error: ' + toErrorMessage(err));
          })
          .jumpToWatchCellM3(sheetId, row, col);
      }

      // Initial load
      refreshList();
    </script>
  </body>
</html>
