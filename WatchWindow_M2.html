<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 12px; color: #333; }
      h3 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 8px; color: #5f6368; }

      .toolbar { display: flex; gap: 8px; margin-bottom: 10px; }
      button {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        background: #fff;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        color: #3c4043;
      }
      button:hover { background: #f1f3f4; }
      button.primary { background: #1a73e8; color: #fff; border: none; }
      button.primary:hover { background: #1558b8; }

      .error-banner {
        background: #fce8e6;
        color: #c5221f;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-bottom: 10px;
        display: none;
        white-space: pre-wrap;
      }

      .watch-table { width: 100%; border-collapse: collapse; border: 1px solid #eee; }
      .watch-table th { text-align: left; padding: 8px; background: #f8f9fa; font-size: 11px; color: #5f6368; border-bottom: 1px solid #eee; }
      .watch-table td { padding: 8px; border-bottom: 1px solid #f1f3f4; font-size: 12px; vertical-align: middle; }
      .watch-table tr:last-child td { border-bottom: none; }

      .sheet-name { font-size: 10px; color: #70757a; display: block; margin-bottom: 2px; }
      .cell-ref { font-family: monospace; font-weight: 700; color: #1967d2; }
      .val-col { text-align: right; font-weight: 600; }

      .action-col { text-align: center; width: 28px; cursor: pointer; font-size: 16px; color: #9aa0a6; }
      .action-col:hover { color: #d93025; background: #fce8e6; }

      .empty-state { text-align: center; padding: 24px 10px; color: #70757a; font-size: 12px; }
      .missing { background: #fff5f5; color: #d93025; }
    </style>
  </head>

  <body>
    <h3>üëÄ Watch Window (M2)</h3>

    <div id="errorBanner" class="error-banner"></div>

    <div class="toolbar">
      <button class="primary" id="btnAdd" onclick="addWatch()">+ Add Watch</button>
      <button id="btnRefresh" onclick="refreshList()">‚Üª Refresh</button>
    </div>

    <div id="tableContainer"></div>

    <script>
      function toErrorMessage(err) {
        try {
          if (err && typeof err === 'object') return err.message || JSON.stringify(err, null, 2);
          return String(err);
        } catch (e) {
          return 'Unknown error (failed to stringify)';
        }
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function setBusy(isBusy) {
        const btnAdd = document.getElementById('btnAdd');
        const btnRefresh = document.getElementById('btnRefresh');
        btnAdd.disabled = isBusy;
        btnRefresh.disabled = isBusy;
        btnRefresh.innerText = isBusy ? '...' : '‚Üª Refresh';
      }

      function showError(err) {
        const banner = document.getElementById('errorBanner');
        banner.style.display = 'block';
        banner.innerText = 'Error: ' + toErrorMessage(err);
      }

      function clearError() {
        const banner = document.getElementById('errorBanner');
        banner.style.display = 'none';
        banner.innerText = '';
      }

      function addWatch() {
        clearError();
        setBusy(true);
        google.script.run
          .withSuccessHandler(() => refreshList())
          .withFailureHandler(err => { setBusy(false); showError(err); })
          .addActiveCellToWatchM2();
      }

      function removeItem(id) {
        clearError();
        const row = document.getElementById('row-' + id);
        if (row) row.style.opacity = '0.4';

        google.script.run
          .withSuccessHandler(() => refreshList())
          .withFailureHandler(err => { if (row) row.style.opacity = '1'; showError(err); })
          .removeWatchItemM2(id);
      }

      function renderList(items) {
        const container = document.getElementById('tableContainer');

        if (!items || items.length === 0) {
          container.innerHTML = '<div class="empty-state">No cells watched yet.<br>Select a cell and click "+ Add Watch".</div>';
          return;
        }

        let html = '<table class="watch-table"><thead><tr><th>Location</th><th class="val-col">Value</th><th></th></tr></thead><tbody>';

        items.forEach(item => {
          if (item.status === 'SHEET_MISSING') {
            html += `
              <tr id="row-${item.id}" class="missing">
                <td>‚ö†Ô∏è Sheet missing (id: ${escapeHtml(item.sheetId)})</td>
                <td class="val-col">${escapeHtml(item.value)}</td>
                <td class="action-col" onclick="removeItem('${item.id}')">&times;</td>
              </tr>
            `;
          } else {
            html += `
              <tr id="row-${item.id}">
                <td>
                  <span class="sheet-name">${escapeHtml(item.sheetName)}</span>
                  <span class="cell-ref">${escapeHtml(item.cellRef)}</span>
                </td>
                <td class="val-col">${escapeHtml(item.value)}</td>
                <td class="action-col" onclick="removeItem('${item.id}')">&times;</td>
              </tr>
            `;
          }
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      }

      function refreshList() {
        clearError();
        setBusy(true);
        google.script.run
          .withSuccessHandler(items => {
            setBusy(false);
            renderList(items);
          })
          .withFailureHandler(err => {
            setBusy(false);
            showError(err);
          })
          .getWatchListM2();
      }

      // Initial load
      refreshList();
    </script>
  </body>
</html>
